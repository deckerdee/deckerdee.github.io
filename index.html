<!DOCTYPE html>
<html>
    <head>
        <style type="text/css">
            body {
                background: #0F0;
                margin: 0;
                padding: 0;
            }

            body > div * {
                position: absolute;
            }
            
            #Background  {
                height: 100%;
            }

            #RightPawUp {
                height: 100%;
            }

            #Right1, #Right2, #Right3, #Right4, #Right5, #Right6, #Right7, #Right8, #RightM,
            #Rdouble1, #Rdouble2, #Rdouble3, #Rdouble4, #Rdouble5, #Rdouble6, #Rdouble7, 
            #Rdouble8, #Rdouble9, #Rdouble10, #RdoubleX {
                height: 100%;
                display: none;
            } 

            #AP2S, #Smoke {
                /*z-index: 1500;*/
                opacity: 0;
                transition: opacity 40ms;
                height: 100%;
            }

            #Button1, #Button2, #Button3, #Button4, #Button5, #Button6, #Button7, #Button8 {
                display: none;
                height: 100%;
            }

            #StickUp, #StickUpRight, #StickRight, 
            #StickDownRight, #StickDown, #StickDownLeft, 
            #StickLeft, #StickUpLeft {
                display: none;
                height: 100%;
            }

            #Container {
                position: relative;
                width: 625px;
                height: 542px;
                left: 5px;
                top: 5px;
                overflow: hidden;
            }

            #Mask1 {
                display: none;
                z-index: 1000;
                background: #0F0;
                position: absolute;
                width: 118px;
                left: -10px;
                height: 160px;
                transform: rotate(8deg);
            }

            #Mask2 {
                display: none;
                z-index: 1000;
                background: #0F0;
                position: absolute;
                width: 119px;
                left: 561px;
                height: 260px;
                transform: rotate(11deg);
            }

        </style>
    </head>
    <body>
        <div id="Mask1"></div>
        <div id="Mask2"></div>
        <div id="Container">
            <img id="Background" src="img/bg.png"></img>
            <img id="RightPawUp" src="img/rightup.png"></img>
		    <!---<img id="LeftPawUp" src="img/leftup.png"></img>
		    <canvas id="RightPawDown" width="612" height="354"></canvas>
		    <canvas id="LeftPawDown" width="612" height="354"></canvas>
		    <img src="img/base.png"></img>
		    <img src="img/buttons.png"></img> --->

            <!--pressed button imgs-->
            <img id="Button1" src="img/b1.png"></img>
            <img id="Button2" src="img/b2.png"></img>
            <img id="Button3" src="img/b3.png"></img>
            <img id="Button4" src="img/b4.png"></img>
            <img id="Button5" src="img/b5.png"></img>
            <img id="Button6" src="img/b6.png"></img>
            <img id="Button7" src="img/b7.png"></img>
            <img id="Button8" src="img/b8.png"></img>

            <!--stick pos imgs-->
            <img style="height: 100%" id="StickNeutral" src="img/stick1.png"></img>
            <img id="StickUp" src="img/stick2.png"></img>
            <img id="StickUpRight" src="img/stick3.png"></img>
            <img id="StickRight" src="img/stick4.png"></img>
            <img id="StickDownRight" src="img/stick5.png"></img>
            <img id="StickDown" src="img/stick6.png"></img>
            <img id="StickDownLeft" src="img/stick7.png"></img>
            <img id="StickLeft" src="img/stick8.png"></img>
            <img id="StickUpLeft" src="img/stick9.png"></img>

            <img id="Right1" src="img/right1.png"></img>
            <img id="Right2" src="img/right2.png"></img>
            <img id="Right3" src="img/right3.png"></img>
            <img id="Right4" src="img/right4.png"></img>
            <img id="Right5" src="img/right5.png"></img>
            <img id="Right6" src="img/right6.png"></img>
            <img id="Right7" src="img/right7.png"></img>
            <img id="Right8" src="img/right8.png"></img>
            <img id="RightM" src="img/rightfist.png"></img>

            <img id="Rdouble1" src="img/rightdouble1.png"></img>
            <img id="Rdouble2" src="img/rightdouble2.png"></img>
            <img id="Rdouble3" src="img/rightdouble3.png"></img>
            <img id="Rdouble4" src="img/rightdouble4.png"></img>
            <img id="Rdouble5" src="img/rightdouble5.png"></img>
            <img id="Rdouble6" src="img/rightdouble6.png"></img>
            <img id="Rdouble7" src="img/rightdouble7.png"></img>
            <img id="Rdouble8" src="img/rightdouble8.png"></img>
            <img id="Rdouble9" src="img/rightdouble9.png"></img>
            <img id="Rdouble10" src="img/rightdouble10.png"></img>
            <img id="RdoubleElse" src="img/rightmulti.png"></img>


            <img id="Smoke" src="img/smoke.png"></img>
            <img id="AP2S" src="img/ap2s.png"></img>
        </div>
    </body>
    <script>
        const STICK_NEUTRAL = 0;
        const STICK_UP = 1;
        const STICK_DOWN = 2;
        const STICK_LEFT = 3;
        const STICK_RIGHT = 4;
        const STICK_UP_LEFT = 5;
        const STICK_UP_RIGHT = 6;
        const STICK_DOWN_LEFT = 7;
        const STICK_DOWN_RIGHT = 8;

        const RIGHT_UP = 0;
        const RIGHT_1 = 1;
        const RIGHT_2 = 2;
        const RIGHT_3 = 3;
        const RIGHT_4 = 4;
        const RIGHT_5 = 5;
        const RIGHT_6 = 6;
        const RIGHT_7 = 7;
        const RIGHT_8 = 8;
        const RIGHT_M = 9;

        /*var rpu = document.getElementById();
        var lpu = document.getElementById();
        var rpd = document.getElementById();
        var lpd = document.getElementById();*/

        /*var rpdctx = rdp.getContext();
        var lpdctx = lpd.getContext();*/

        var StickElements = [
            document.getElementById("StickNeutral"),
            document.getElementById("StickUp"),
            document.getElementById("StickDown"),
            document.getElementById("StickLeft"),
            document.getElementById("StickRight"),
            document.getElementById("StickUpLeft"),
            document.getElementById("StickUpRight"),
            document.getElementById("StickDownLeft"),
            document.getElementById("StickDownRight")
        ];

        var ButtonElements = [
            document.getElementById("Button1"),
            document.getElementById("Button2"),
            document.getElementById("Button3"),
            document.getElementById("Button4"),
            document.getElementById("Button5"),
            document.getElementById("Button6"),
            document.getElementById("Button7"),
            document.getElementById("Button8")
        ];

        var HandElements = [
            document.getElementById("Right1"),
            document.getElementById("Right2"),
            document.getElementById("Right3"),
            document.getElementById("Right4"),
            document.getElementById("Right5"),
            document.getElementById("Right6"),
            document.getElementById("Right7"),
            document.getElementById("Right8"),
            document.getElementById("RightM"),
            document.getElementById("RightPawUp")
        ]

        var DoubleElements = [
        document.getElementById("Rdouble1"),
        document.getElementById("Rdouble2"),
        document.getElementById("Rdouble3"),
        document.getElementById("Rdouble4"),
        document.getElementById("Rdouble5"),
        document.getElementById("Rdouble6"),
        document.getElementById("Rdouble7"),
        document.getElementById("Rdouble8"),
        document.getElementById("Rdouble9"),
        document.getElementById("Rdouble10")
        ]

        //Extras
        var Smoke = document.getElementById("Smoke");
        var SmokeTimeout = 2000;
        var SmokeTimer = null;

        var AP2S = document.getElementById("AP2S");
        var currentAP2S = [];
        var AP2SThreshold = 15;
        var AP2STimer = null;
        var AP2STimeout = 500;

        //Gamepads
        var connected = null;
        var buttons = null;
        var rHand = RIGHT_UP;
        var direction = STICK_NEUTRAL;

        var gamepadIdx = 0;
        var upButtonIdx = 12;
        var downButtonIdx = 13;
        var leftButtonIdx = 14;
        var rightButtonIdx = 15;

        /*Romolla button layout:
                p  k   s
                h dash d        */
        var buttonIdx = [2, 3, 5, 4, 
                         0, 1, 7, 6];
        var smokeButtonIdx = 7;

        var axeActiveThreshold = 0.4;

        /*var pawCurvesButtons = [
		[110,190, 290,370, 220,160],
		[110,190, 160,350, 220,160],
		[ 90,190,  40,320, 220,160],

		[110,190, 310,310, 220,160],
		[110,190, 180,290, 220,160],
		[ 90,190,  50,260, 220,160],
    ];

	    //Left hand for the stick
	    var pawCurvesStick = [
		[290,240, 390,280, 465,200], // neutral
		[290,260, 370,300, 465,200], // up
		[300,260, 390,270, 465,200], // down
		[360,250, 390,290, 465,200], // left
		[250,230, 350,290, 465,200], // right
		[310,260, 390,290, 465,200], // up left
		[275,245, 350,290, 465,200], // up right
		[320,260, 410,270, 465,200], // down left
		[270,240, 390,280, 465,200], // down right
    ];

	    var RPSpeed = 0.7;
	    var RPReleaseTimeout = 0;
	    var RPReleaseTimer = null;
	    var currentRPCurve = null;
	    var currentRPCurveTarget = null;

	    var LPSpeed = 0.7;
	    var LPReleaseTimeout = 2000;
	    var LPReleaseTimer = null;
	    var currentLPCurve = null;
	    var currentLPCurveTarget = null;*/

        readConfig();

        window.addEventListener("gamepadconnected", function(e) {
            connected = window.navigator.getGamepads()[e.gamepad.index];
            console.log("Gamepad " + e.gamepad.index + " connected");
            requestAnimationFrame(pollGamepadButtons);
        });

        function readConfig() {
            var config = window.location.search;
            var gamepadMatch = config.match(/[?&]gamepad=(\d+)/);
            var buttonsMatch = config.match(/[?&]buttons=([\d,]+)/);
            var deadzoneMatch = config.match(/[?&]deadzone=([\d\.]+)/);
            var ap2sMatch = config.match(/[?&]ap2s=([\d]+)/);

            if(gamepadMatch) {
                gamepadIdx = Number.parseInt(gamepadMatch[1]);
            }

            if(buttonsMatch) {
                var buttonStrings = buttonsMatch[1].split(",");

                if(buttonStrings.length == 12) {
                    upButtonIdx = Number.parseInt(buttonStrings[0], 10);
                    downButtonIdx = Number.parseInt(buttonStrings[1], 10);
                    leftButtonIdx = Number.parseInt(buttonStrings[2], 10);
                    rightButtonIdx = Number.parseInt(buttonStrings[3], 10);

                    for(var i = 0; i < buttonIdx.length; i++) {
                        buttonIdx[i] = Number.parseInt(buttonStrings[i + 4], 10);
                    }
                }
            }

            if(deadzoneMatch) {
                axeActiveThreshold = Number.parseFloat(deadzoneMatch[1]);
            }

            if(ap2sMatch) {
                AP2SThreshold = Number.parseInt(ap2sMatch[1]);
            }
        }

        function pollGamepadButtons() {
            requestAnimationFrame(pollGamepadButtons);

            if(!connected) {
                return;
            }

            var gamepads = window.navigator.getGamepads();

            if(gamepadIdx >= gamepads.length) {
                return;
            }

            var axes = [];

            for(var i = 0; i < gamepads[gamepadIdx].axes.length; i++) {
                var val = gamepads[gamepadIdx].axes[i];
                axes.push({pressed: val > axeActiveThreshold ? true : false});
                axes.push({pressed: val < -axeActiveThreshold ? true : false});
            };

            var newButtons = gamepads[gamepadIdx].buttons.concat(axes);

            selectAP2SState(newButtons);

            buttons = newButtons;

            var btnStr = "";
            for(var i = 0; i < buttons.length; i++) {
                if(buttons[i].pressed) {
                    btnStr += i + ": pressed\t";
                }
            }

            btnStr = "AP2S: " + currentAP2S.length + " \t" + btnStr;
            console.log(btnStr);

            direction = getStickDirection();

            selectStickState();
            selectButtonState();
            //selectHandState();
            getHandPos();
            //selectSmokeState();
            /*selectRPTarget();
            selectLPTarget();
            
            adjustRPCurve();
            adjustLPCurve();
            
            drawRPD(currentRPCurve);
            drawLPD(currentLPCurve);*/
        }

        function selectAP2SState(newButtons) {
            if(!buttons) {
                return 0;
            }

            var currentTime = Date.now();

            currentAP2S = currentAP2S.filter(function(deadline) {
                return deadline > Date.now();
            });

            for(var i = 0; i < buttons.length; i++) {
                if(!buttons[i].pressed && newButtons[i].pressed) {
                    if( i === upButtonIdx || i === downButtonIdx || i === leftButtonIdx || i === rightButtonIdx) {
                        currentAP2S.push(currentTime + 1600);
                    } else if(buttonIdx.indexOf(i) >= 0) {
                        currentAP2S.push(currentTime + 2000);
                    }
                }
            }

            if(currentAP2S.length >= AP2SThreshold) {
                AP2S.style.opacity = 1;
                if(AP2STimer) {
                    clearTimeout(AP2STimer);
                    AP2STimer = null;
                }
            } else {
                if(!AP2STimer) {
                    AP2STimer = setTimeout(function() {
                        AP2S.style.opacity = 0;
                    }, AP2STimeout);
                }
            }
        }

        function selectSmokeState() {
            if(buttons[smokeButtonIdx].pressed) {
                Smoke.style.opacity = 1;
                if(SmokeTimer) {
                    clearTimeout(SmokeTimeout);
                    SmokeTimer = null;
                }
            } else {
                if(!SmokeTimer) {
                    SmokeTimer = setTimeout(function() {
                        Smoke.style.opacity = 0;
                    }, SmokeTimeout);
                }
            }
        }

        /*function adjustRPCurve() {
		    if(!currentRPCurve) {
			currentRPCurve = currentRPCurveTarget;
			return;
		    }

		    for(var i = 0; i < currentRPCurve.length; i++) {
			currentRPCurve[i] = currentRPCurve[i] + (currentRPCurveTarget[i] - currentRPCurve[i]) * RPSpeed;
		    }
	    }

	    function adjustLPCurve() {
		    if(!currentLPCurve) {
			    currentLPCurve = currentLPCurveTarget;
			    return;
		    }

		    for(var i = 0; i < currentLPCurve.length; i++) {
			    currentLPCurve[i] = currentLPCurve[i] + (currentLPCurveTarget[i] - currentLPCurve[i]) * LPSpeed;
		    }
	    }*/

        function getStickDirection() {
            var upPressed = buttons[upButtonIdx].pressed;
            var downPressed = buttons[downButtonIdx].pressed;
            var leftPressed = buttons[leftButtonIdx].pressed;
            var rightPressed = buttons[rightButtonIdx].pressed;

            if(upPressed && leftPressed) {
                return STICK_UP_LEFT;
            } else if (upPressed && rightPressed) {
                return STICK_UP_RIGHT;
            } else if (downPressed && leftPressed) {
                return STICK_DOWN_LEFT;
            } else if (downPressed && rightPressed) {
                return STICK_DOWN_RIGHT;
            } else if (upPressed) {
                return STICK_UP;
            } else if (downPressed) {
                return STICK_DOWN;
            } else if (leftPressed) {
                return STICK_LEFT;
            } else if (rightPressed) {
                return STICK_RIGHT;
            } else {
                return STICK_NEUTRAL;
            }
        }

        function selectStickState() {
            for(var i = 0; i < StickElements.length; i++) {
                StickElements[i].style.display = (i == direction ? "block" : "none");
            }
        }

        function selectButtonState() {
            for(var i = 0; i < ButtonElements.length; i++) {
                var pressed = buttons[buttonIdx[i]].pressed;
                ButtonElements[i].style.display = (pressed ? "block" : "none");
            }
        }

        function getHandPos() {
            var countPressed = 0;
            for(var i = 0; i < ButtonElements.length; i++) {
                if(buttons[buttonIdx[i]].pressed) {
                    countPressed++;
                }
            }

            if(countPressed == 1) {
                document.getElementById("RightPawUp").style.display = "none";
                document.getElementById("RightM").style.display = "none";
                for(var i = 0; i < DoubleElements.length; i++) {
                    document.getElementById("Rdouble" + [i+1]).style.display = "none";
                }
                for(var i = 0; i < HandElements.length; i++) {
                    var pressed = buttons[buttonIdx[i]].pressed;
                    HandElements[i].style.display = (pressed ? "block" : "none");
                }
            } else if(countPressed == 2) {
                document.getElementById("RightM").style.display = "none";
                document.getElementById("RightPawUp").style.display = "none";
                for(var i = 0; i < DoubleElements.length; i++) {
                    document.getElementById("Rdouble" + [i+1]).style.display = "none";
                }
                for(var i = 0; i < HandElements.length; i++) {
                    HandElements[i].style.display = "none";
                }

                if(buttons[buttonIdx[0]].pressed && buttons[buttonIdx[1]].pressed) {
                    document.getElementById("Rdouble1").style.display = "block";
                } else if(buttons[buttonIdx[1]].pressed && buttons[buttonIdx[2]].pressed) {
                    document.getElementById("Rdouble2").style.display = "block";
                } else if(buttons[buttonIdx[2]].pressed && buttons[buttonIdx[3]].pressed) {
                    document.getElementById("Rdouble3").style.display = "block";
                } else if(buttons[buttonIdx[0]].pressed && buttons[buttonIdx[4]].pressed) {
                    document.getElementById("Rdouble4").style.display = "block";
                } else if(buttons[buttonIdx[1]].pressed && buttons[buttonIdx[5]].pressed) {
                    document.getElementById("Rdouble5").style.display = "block";
                } else if(buttons[buttonIdx[2]].pressed && buttons[buttonIdx[6]].pressed) {
                    document.getElementById("Rdouble6").style.display = "block";
                } else if(buttons[buttonIdx[3]].pressed && buttons[buttonIdx[7]].pressed) {
                    document.getElementById("Rdouble7").style.display = "block";
                } else if(buttons[buttonIdx[4]].pressed && buttons[buttonIdx[5]].pressed) {
                    document.getElementById("Rdouble8").style.display = "block";
                } else if(buttons[buttonIdx[5]].pressed && buttons[buttonIdx[6]].pressed) {
                    document.getElementById("Rdouble9").style.display = "block";
                } else if(buttons[buttonIdx[6]].pressed && buttons[buttonIdx[7]].pressed) {
                    document.getElementById("Rdouble10").style.display = "block";
                } else {
                    document.getElementById("Rdouble2").style.display = "block";
                }
                //document.getElementById("RightM").style.display = "block";
            } else if(countPressed >= 3) {
                document.getElementById("RightM").style.display = "none";
                document.getElementById("RightPawUp").style.display = "none";
                for(var i = 0; i < DoubleElements.length; i++) {
                    document.getElementById("Rdouble" + [i+1]).style.display = "none";
                }
                for(var i = 0; i < HandElements.length; i++) {
                    HandElements[i].style.display = "none";
                }

                document.getElementById("RightM").style.display = "block";
            } else {
                for(var i = 0; i < DoubleElements.length; i++) {
                    document.getElementById("Rdouble" + [i+1]).style.display = "none";
                }
                for(var i = 0; i < HandElements.length; i++) {
                    HandElements[i].style.display = "none";
                }
                document.getElementById("RightPawUp").style.display = "block";
            }
        }

        /*function selectHandState() {
            for(var i = 0; i < HandElements.length; i++) {
                var pressed = buttons[buttonIdx[i]].pressed;
                HandElements[i].style.display = (pressed ? "block" : "none");
            }
        }*/

        /*function selectRPTarget() {
		    var countPressed = 0;
		    var arraySum = [0,0, 0,0, 0,0];

		    //Sum bezier curves
		    for(var j = 0; j < ButtonElements.length; j++) {
			    if(buttons[buttonIdx[j]].pressed) {
				    for(var i = 0; i < arraySum.length; i++) {
					    arraySum[i] += pawCurvesButtons[j][i];
				    }
				    countPressed++;
			    }
		    }

		    //Average values and set minimum hold timer
		    if(countPressed > 0) {
			    for(var i = 0; i < arraySum.length; i++) {
				    arraySum[i] = Math.floor(arraySum[i] / countPressed);
			    }
			    currentRPCurveTarget = arraySum;
			    if(RPReleaseTimer) {
				    clearTimeout(RPReleaseTimer);
				    RPReleaseTimer = null;
			    }
		    } else {
			    if(!RPReleaseTimer) {
				    RPReleaseTimer = setTimeout(function() {
					    currentRPCurve = null;
					    currentRPCurveTarget = null;
				    }, RPReleaseTimeout);
			    }
		    }
	    }

	    function selectLPTarget() {
		    var countPressed = 0;
		    var arraySum = [0,0, 0,0, 0,0];

		    //Sum bezier curves
		    if(direction != STICK_NEUTRAL) {
			    for(var i = 0; i < arraySum.length; i++) {
				    arraySum[i] += pawCurvesStick[direction][i];
			    }
			    countPressed++;
		    }

		    if(countPressed === 0) {
			    if(!LPReleaseTimer) {
				    if(currentLPCurveTarget) {
					    currentLPCurveTarget = pawCurvesStick[STICK_NEUTRAL]; //Set to Neutral
				    }
				    LPReleaseTimer = setTimeout(function() {
					    currentLPCurve = null;
					    currentLPCurveTarget = null;
				    }, LPReleaseTimeout);
			    }
		    } else {
			    //Average values, possible 2
			    for(var i = 0; i < arraySum.length; i++) {
				    arraySum[i] = Math.floor(arraySum[i] / countPressed);
			    }
			    currentLPCurveTarget = arraySum;
			    if(LPReleaseTimer) {
				    clearTimeout(LPReleaseTimer);
				    LPReleaseTimer = null;
			    }
		    }
	    }

	    function drawRPD(curve) {
		    if(!curve) {
			    //Draw hand up
			    rpu.style.display = "block";
			    rpd.style.display = "none";
			    return;
		    }

		    rpu.style.display = "none";
		    rpd.style.display = "block";

		    rpdctx.clearRect(0, 0, rpdctx.canvas.width, rpdctx.canvas.height);
		    rpdctx.lineWidth = 6;
		    rpdctx.fillStyle = "white";
		    rpdctx.lineCap = "round";
		    rpdctx.beginPath();
		    rpdctx.moveTo(177, 104);
		    rpdctx.bezierCurveTo(curve[0], curve[1], curve[2], curve[3], curve[4], curve[5]);

		    rpdctx.fill();
		    rpdctx.stroke();
	    }

	    function drawLPD(curve) {
		    if(!curve) {
			    //Draw hand up
			    lpu.style.display = "block";
			    lpd.style.display = "none";
			    return;
		    }
		    lpu.style.display = "none";
		    lpd.style.display = "block";

		    lpdctx.clearRect(0, 0, lpdctx.canvas.width, lpdctx.canvas.height);
		    lpdctx.lineWidth = 6;
		    lpdctx.fillStyle = "white";
		    lpdctx.lineCap = "round";
		    lpdctx.beginPath();
		    lpdctx.moveTo(360,200);
		    lpdctx.bezierCurveTo(curve[0], curve[1], curve[2], curve[3], curve[4], curve[5]);

		    lpdctx.fill();
		    lpdctx.stroke();
	    }*/

    </script>
</html>